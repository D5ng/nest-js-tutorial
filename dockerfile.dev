# =============================================================================
# NestJS 앱 — 개발용 Dockerfile (devDependencies 포함)
# =============================================================================
# 프로덕션용은 dockerfile, 개발용은 이 파일(dockerfile.dev).
# docker compose -f docker-compose.dev.yaml up --build 로 사용.
# =============================================================================

FROM node:20-alpine AS builder

WORKDIR /usr/src/app

RUN corepack enable && corepack prepare pnpm@latest --activate

COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

COPY . .
RUN pnpm run build

# -----------------------------------------------------------------------------
# 2단계: 러너 — 개발용이므로 dependencies + devDependencies 전부 설치
# -----------------------------------------------------------------------------
FROM node:20-alpine AS runner

WORKDIR /usr/src/app

RUN corepack enable && corepack prepare pnpm@latest --activate

# 개발: devDependencies 포함 (class-validator 등 런타임에 쓰는 dev 의존성 포함)
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

COPY --from=builder /usr/src/app/dist ./dist

USER node

ENV NODE_ENV=development
ENV PORT=8080

EXPOSE 8080

CMD ["node", "dist/main.js"]
