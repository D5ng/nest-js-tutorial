# Docker 기초 개념

---

## 1. Docker가 뭔가요?

### 한 줄로

**"내 앱이 돌아가는 환경(OS + 런타임 + 의존성)을 통째로 하나의 패키지처럼 만들어서, 어디서든 똑같이 돌리게 하는 도구"**라고 보면 됩니다.

### 이미지 vs 컨테이너

| 용어                    | 비유                                      | 설명                                                                                            |
| ----------------------- | ----------------------------------------- | ----------------------------------------------------------------------------------------------- |
| **이미지(Image)**       | 설계도 + 재료가 담긴 상자                 | 실행 가능한 파일 시스템 + 설정. **읽기 전용**. `docker build`로 만듦.                           |
| **컨테이너(Container)** | 그 상자를 열어서 실제로 돌아가는 프로세스 | 이미지를 **실행한 상태**. 프로세스가 돌아가고, 파일을 쓰고 지울 수 있음. `docker run`으로 만듦. |

- 이미지 하나로 컨테이너를 **여러 개** 띄울 수 있어요 (같은 앱을 여러 인스턴스로).
- 컨테이너를 지우면 그 안에서 쓴 데이터는 사라지고, 이미지는 그대로 남아요.

---

## 2. Dockerfile이 뭔가요?

**"이미지를 어떻게 만들지"를 적어 둔 설계도**예요.

- **어떤 기본 이미지**에서 시작할지 (예: `node:20-alpine`)
- **어떤 파일을 복사**하고, **어떤 명령을 실행**할지
- **실행할 때 기본으로 뭘 돌릴지** (예: `node dist/main.js`)

를 한 줄 한 줄 적어 두면, Docker가 그걸 읽고 **레이어를 쌓아서** 최종 이미지를 만들어 줍니다.

---

## 3. 레이어(Layer)란?

Dockerfile의 **한 줄 한 줄(실제로는 RUN, COPY 등)**이 각각 **하나의 레이어**가 됩니다.

- 각 레이어는 **캐시**될 수 있어요.
- **어느 한 줄이 바뀌면**, 그 줄부터 아래 레이어는 **다시** 만들고, 위쪽은 캐시를 그대로 씁니다.
- 그래서 **자주 안 바뀌는 것**(예: `package.json` 복사 + `npm ci`)을 **위에** 두고, **자주 바뀌는 것**(소스 복사 + 빌드)을 **아래**에 두면 빌드가 빨라져요.

---

## 4. 빌드 컨텍스트(Build Context)

`docker build`를 실행하면, **지정한 폴더 전체**가 Docker 데몬으로 전달됩니다. 이걸 **빌드 컨텍스트**라고 해요.

- `COPY . .` 는 "컨텍스트 안의 파일"을 이미지로 복사하는데,
- **`.dockerignore`에 적힌 경로/파일은 컨텍스트에서 제외**되므로 복사되지 않아요.
- 그래서 `node_modules`, `.git`, `.env` 같은 걸 넣지 않으면 **빌드가 빨라지고**, **보안도** 좋아져요.

---

## 5. 멀티 스테이지 빌드란?

**Dockerfile 안에 `FROM`이 여러 번** 나오면, **여러 "스테이지"**가 생깁니다.

- **1단계(builder)**: TypeScript 빌드용. `npm ci`(전체 의존성) + `npm run build` → `dist/` 생성.
- **2단계(runner)**: 실제 서비스용. `npm ci --only=production` + builder에서 만든 `dist/`만 가져옴.

**왜 나누나요?**

- 최종 이미지에는 **실행에 필요한 것만** 넣고 싶어요.
- 빌드 도구(tsc, nest-cli, devDependencies)는 **실행 시엔 필요 없어서** 두 번째 스테이지에 안 넣음.
- 그 결과 **이미지 크기가 작아지고**, 불필요한 도구가 노출되지 않아 **보안**에도 좋아요.
